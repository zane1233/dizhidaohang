<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å¯¼èˆªåŠ©æ‰‹</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:"PingFang SC","Microsoft YaHei",sans-serif;background:#f5f5f5;min-height:100vh}

        .top{background:linear-gradient(135deg,#ff6b35,#f7931e);padding:22px 16px 18px;text-align:center;color:#fff}
        .top h1{font-size:24px;font-weight:700;margin-bottom:4px}
        .top p{font-size:13px;opacity:.88}

        .body{padding:14px}

        .guide{background:#fff8f0;border:1.5px solid #ffe0b2;border-radius:14px;padding:14px 16px;margin-bottom:14px}
        .guide h3{color:#e65100;font-size:15px;margin-bottom:10px}
        .guide-row{display:flex;align-items:flex-start;font-size:14px;color:#555;margin-bottom:7px;line-height:1.5}
        .gn{background:#ff6b35;color:#fff;border-radius:50%;min-width:20px;height:20px;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;margin-right:8px;margin-top:1px;flex-shrink:0}

        .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.07);margin-bottom:14px}
        .card-title{font-size:17px;font-weight:700;color:#222;margin-bottom:14px;display:flex;align-items:center;gap:8px}

        .paste-box{width:100%;min-height:160px;padding:14px;border:2px dashed #e0e0e0;border-radius:12px;font-size:16px;font-family:inherit;color:#333;resize:none;background:#fafafa;line-height:1.7;transition:border-color .3s}
        .paste-box:focus{outline:none;border-color:#ff6b35;background:#fff}

        .clear-btn{margin-top:10px;padding:8px 18px;background:#f5f5f5;border:none;border-radius:8px;font-size:14px;color:#888;cursor:pointer}

        .results{display:none;margin-top:4px}
        .results.show{display:block}
        .results-label{font-size:14px;color:#ff6b35;font-weight:600;margin-bottom:10px}

        .addr-card{background:#fff;border-radius:14px;padding:16px;margin-bottom:12px;box-shadow:0 2px 10px rgba(0,0,0,.07);border-left:5px solid #ff6b35}
        .addr-no{font-size:12px;color:#ff6b35;font-weight:600;margin-bottom:5px}
        .addr-name{font-size:20px;font-weight:700;color:#111;margin-bottom:8px;line-height:1.4}
        .addr-meta{font-size:13px;color:#888;line-height:1.8;margin-bottom:12px}

        .btn-row{display:flex;gap:8px}
        .btn-copy{flex:1;padding:13px 0;background:#f5f5f5;border:none;border-radius:10px;font-size:15px;font-weight:600;color:#555;cursor:pointer;transition:all .2s}
        .btn-copy.ok{background:#e8f5e9;color:#2e7d32}

        .btn-nav{flex:2.5;padding:13px 0;background:linear-gradient(135deg,#ff6b35,#f7931e);border:none;border-radius:10px;font-size:16px;font-weight:700;color:#fff;cursor:pointer;box-shadow:0 4px 12px rgba(255,107,53,.35);display:flex;align-items:center;justify-content:center;gap:6px}
        .btn-nav:active{opacity:.85;transform:scale(.98)}
        .btn-nav.loading{opacity:.7;pointer-events:none}

        .nav-spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;display:none}
        .btn-nav.loading .nav-spinner{display:block}

        .empty{text-align:center;padding:30px 0;color:#bbb;font-size:15px;display:none}
        .empty.show{display:block}

        .err{background:#fff3f3;border-left:4px solid #f44336;border-radius:10px;padding:12px 14px;font-size:14px;color:#c62828;margin-top:10px;display:none}
        .err.show{display:block}

        /* æç¤ºå¼¹çª— */
        .toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.75);color:#fff;padding:10px 22px;border-radius:24px;font-size:14px;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;z-index:999}
        .toast.show{opacity:1}

        /* æœ€ç»ˆè¯´æ˜æ¡ */
        .notice{background:#e3f2fd;border-radius:12px;padding:12px 14px;margin-bottom:14px;font-size:13px;color:#1565c0;line-height:1.6;border-left:4px solid #2196f3}
        .notice b{color:#0d47a1}

        .footer{text-align:center;font-size:12px;color:#bbb;padding:10px 0 24px}
    </style>
</head>
<body>

<div class="top">
    <h1>ğŸ  å®¶æ”¿å¯¼èˆªåŠ©æ‰‹</h1>
    <p>ç²˜è´´ä»»åŠ¡æ–‡å­— â†’ è‡ªåŠ¨è¯†åˆ« â†’ ä¸€é”®å¯¼èˆª</p>
</div>

<div class="body">

    <div class="guide">
        <h3>ğŸ“– æ€ä¹ˆç”¨ï¼ˆ3æ­¥æå®šï¼‰</h3>
        <div class="guide-row"><span class="gn">1</span><span>é•¿æŒ‰å¾®ä¿¡é‡Œçš„<b>ä»»åŠ¡æ–‡å­—</b>ï¼Œç‚¹<b>å¤åˆ¶</b></span></div>
        <div class="guide-row"><span class="gn">2</span><span>å›åˆ°è¿™é‡Œï¼Œ<b>é•¿æŒ‰ä¸‹é¢çš„æ¡†</b>ï¼Œç‚¹<b>ç²˜è´´</b></span></div>
        <div class="guide-row"><span class="gn">3</span><span>ç‚¹æ©™è‰² <b>ğŸ§­ ç«‹å³å¯¼èˆª</b>ï¼Œé«˜å¾·åœ°å›¾è‡ªåŠ¨æ‰“å¼€ï¼Œå†ç‚¹ä¸€æ¬¡<b>"å¼€å§‹å¯¼èˆª"</b>å‡ºå‘ï¼</span></div>
    </div>

    <!-- é‡è¦è¯´æ˜ -->
    <div class="notice">
        â„¹ï¸ <b>å…³äºå¯¼èˆªè·³è½¬è¯´æ˜ï¼š</b><br>
        ç‚¹"ç«‹å³å¯¼èˆª"åä¼šè‡ªåŠ¨æ‰“å¼€é«˜å¾·åœ°å›¾ï¼Œå¹¶æ˜¾ç¤º<b>è·¯çº¿è§„åˆ’é¡µé¢</b>ï¼ˆç›®çš„åœ°å·²è‡ªåŠ¨å¡«å¥½ï¼‰ã€‚<br>
        ç”±äºé«˜å¾·åœ°å›¾å®‰å…¨é™åˆ¶ï¼Œéœ€åœ¨é«˜å¾·é‡Œå†ç‚¹ä¸€æ¬¡<b>"å¼€å§‹å¯¼èˆª"</b>æ‰èƒ½å‡ºå‘ï¼Œè¿™æ˜¯æ‰€æœ‰åœ°å›¾APPçš„è§„å®šï¼Œæ— æ³•è·³è¿‡ã€‚
    </div>

    <div class="card">
        <div class="card-title">ğŸ“‹ åœ¨è¿™é‡Œç²˜è´´ä»»åŠ¡å†…å®¹</div>
        <textarea class="paste-box" id="txt"
            placeholder="é•¿æŒ‰è¿™é‡Œ â†’ ç²˜è´´&#10;&#10;å†…å®¹ç²˜è´´åè‡ªåŠ¨è¯†åˆ«æ‰€æœ‰åœ°å€ ğŸ˜Š&#10;&#10;æ”¯æŒæ ¼å¼ï¼š&#10;â€¢ åœ°å€ï¼šæ²³è¥¿åŒº å…°æ±Ÿæ–°è‹‘&#10;â€¢ æ²³è¥¿åŒº å–œå¹´å¹¿åœºï¼Œæ—¥å¸¸2å°æ—¶&#10;â€¢ æ˜å¤©10ç‚¹ï¼Œä¸œä¸½åŒº æ¶¦å›­..."></textarea>
        <button class="clear-btn" onclick="clearAll()">âœ• æ¸…ç©ºé‡æ¥</button>
        <div class="err" id="err"></div>
    </div>

    <div class="results" id="results">
        <div class="results-label" id="rlabel"></div>
        <div id="addrList"></div>
    </div>

    <div class="empty" id="empty">æœªè¯†åˆ«åˆ°åœ°å€ï¼Œè¯·ç¡®è®¤æ–‡å­—ä¸­æœ‰å…·ä½“åœ°ç‚¹</div>
    <div class="footer">å¯¼èˆªåŠ©æ‰‹ Â· å…è´¹ä½¿ç”¨</div>
</div>

<div class="toast" id="toast"></div>

<script>
    let addrs = [];
    // é«˜å¾·åœ°å›¾WebæœåŠ¡Keyï¼ˆå…è´¹ï¼Œç”¨äºåœ°å€è½¬åæ ‡ï¼‰
    // è¿™é‡Œç”¨çš„æ˜¯é«˜å¾·å®˜æ–¹å¼€æ”¾çš„å…è´¹Web API
    const AMAP_KEY = 'f016c324446cdc91ea3297560d1d5925'; // å…¬å¼€æ¼”ç¤ºkey

    const txt = document.getElementById('txt');
    txt.addEventListener('input', function(){
        clearTimeout(txt._t);
        const val = this.value.trim();
        if(!val){ clearResults(); return; }
        txt._t = setTimeout(()=>run(val), 400);
    });

    function run(content){
        addrs = parse(content);
        render(addrs);
    }

    // -------- åœ°å€è§£æ --------
    function parse(text){
        const res = [];
        const blocks = text.split(/(?=\n?[0-9ï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–ï¼—ï¼˜ï¼™]+[ã€.ï¼)\s]|\n?(?:æ˜å¤©|ä»Šå¤©|åå¤©|æ˜æ—¥))/);
        for(let b of blocks){
            if(!b.trim()) continue;
            const addr = findAddr(b);
            if(!addr) continue;
            res.push({ address:addr, time:findTime(b), project:findProject(b), pay:findPay(b), lat:null, lng:null });
        }
        if(!res.length){
            for(let line of text.split('\n')){
                const a = findAddr(line);
                if(a && !res.find(r=>r.address===a))
                    res.push({address:a,time:'',project:'',pay:'',lat:null,lng:null});
            }
        }
        return res;
    }

    function findAddr(t){
        const ps=[
            /åœ°å€[ï¼š:]\s*([^\nï¼Œ,ã€‚ï¼!ï¼Ÿ?]+)/,
            /([^\sï¼Œ,ã€‚\n]{1,6}(?:åŒº|å¿)\s{0,2}[^\sï¼Œ,ã€‚\n]{2,}(?:å¹¿åœº|å¤§å¦|å°åŒº|å…¬å¯“|èŠ±å›­|ä¸­å¿ƒ|å¤§è¡—|è·¯|è¡—|å›­|åŸ|è‹‘|åºœ|å±…|åº­|é‡Œ|æ‘|åº—|é™¢|æ¥¼|é¦†|åœº|ç«™|æ¡¥|åŠ|å··|å¼„|æ–°è‹‘|èŠ±è‹‘|åè‹‘|è±ªåº­|å¾¡è‹‘|å®¶å›­|å±±åº„|ååºœ|ç¿ åº­|ä¸½æ™¯|å˜‰å›­|åº·åŸ|ç¾è‹‘|ç¿ è‹‘|ç«ç‘°|æ˜Ÿæ²³|é‡‘åœ°|ç¢§æ¡‚|ä¿åˆ©|ä¸‡ç§‘|æ’å¤§|ç»¿åœ°|é¾™æ¹–)[^\sï¼Œ,ã€‚\nï¼!ï¼Ÿ?]*)/,
            /([^\sï¼Œ,ã€‚\n]{1,6}(?:åŒº|å¿)[^\sï¼Œ,ã€‚\nï¼!ï¼Ÿ?]{1,15}(?:è·¯|è¡—|é“)[^\sï¼Œ,ã€‚\nï¼!ï¼Ÿ?]{0,10})/,
            /([\u4e00-\u9fa5]{2,8}(?:å¹¿åœº|å¤§å¦|å°åŒº|å…¬å¯“|èŠ±å›­|ä¸­å¿ƒ|å›­åŒº|åŸå¸‚|è‹‘|å•†åœº|å¤§æ¥¼|é…’åº—|åŒ»é™¢|å¸‚åœº|è¶…å¸‚|æ–°è‹‘|èŠ±è‹‘|åè‹‘|å®¶å›­|å±±åº„))/,
            /([\u4e00-\u9fa5]{2,6}(?:è·¯|è¡—|å¤§é“|å¤§è¡—)\d{1,4}å·?)/
        ];
        for(let p of ps){
            const m=t.match(p);
            if(m){ let a=m[1].trim().replace(/[ï¼Œ,ã€‚ï¼!ï¼Ÿ?\s]+$/,''); if(a.length>=3) return a; }
        }
        return null;
    }
    function findTime(t){ const m=t.match(/(\d{4}[-\/]\d{1,2}[-\/]\d{1,2}[^\nï¼Œ,]{0,6}|\d{1,2}æœˆ\d{1,2}[æ—¥å·][^\nï¼Œ,]{0,6}|(?:ä¸Šåˆ|ä¸‹åˆ|æ—©ä¸Š|ä¸­åˆ|æ™šä¸Š)[^\nï¼Œ,]{0,10}|\d{1,2}[ç‚¹:ï¼š]\d{0,2}(?:åˆ†)?|æ—¶é—´[ï¼š:][^\nï¼Œ,]{1,20})/); return m?m[0].trim():''; }
    function findProject(t){ const m=t.match(/((?:æ—¥å¸¸|æ·±åº¦|å¼€è’|æ ‡å‡†|ç²¾ç»†)[^ï¼Œ,\nï¼!]{0,10}|ä¿æ´[^ï¼Œ,\nï¼!]{0,8}|\d+\s*å°æ—¶[^ï¼Œ,\nï¼!]{0,8}|é¡¹ç›®[ï¼š:][^ï¼Œ,\n]{1,15})/); return m?m[0].trim():''; }
    function findPay(t){ const m=t.match(/(åˆ°æ‰‹[ï¼š:]\s*[\d+Ã—x\*]+\s*å…ƒ?|[\d+]+\s*å…ƒ(?!\d)|Â¥\s*[\d+]+)/); return m?m[0].trim():''; }

    // -------- æ¸²æŸ“ --------
    function render(list){
        const sec=document.getElementById('results');
        const empty=document.getElementById('empty');
        const lbl=document.getElementById('rlabel');
        const box=document.getElementById('addrList');
        if(!list.length){ sec.classList.remove('show'); empty.classList.add('show'); return; }
        empty.classList.remove('show');
        lbl.textContent=`âœ… è¯†åˆ«åˆ° ${list.length} ä¸ªåœ°å€ï¼Œç‚¹æ©™è‰²æŒ‰é’®å¯¼èˆª ğŸ‘‡`;
        box.innerHTML='';
        list.forEach((item,i)=>{
            let meta='';
            if(item.time)    meta+=`â° ${item.time}ã€€`;
            if(item.project) meta+=`ğŸ“‹ ${item.project}ã€€`;
            if(item.pay)     meta+=`ğŸ’° ${item.pay}`;
            const d=document.createElement('div');
            d.className='addr-card';
            d.innerHTML=`
                <div class="addr-no">ç¬¬ ${i+1} ä¸ªåœ°å€</div>
                <div class="addr-name">ğŸ“ ${item.address}</div>
                ${meta?`<div class="addr-meta">${meta.trim()}</div>`:''}
                <div class="btn-row">
                    <button class="btn-copy" id="cp${i}" onclick="copyAddr(${i})">ğŸ“‹ å¤åˆ¶åœ°å€</button>
                    <button class="btn-nav" id="nav${i}" onclick="navTo(${i})">
                        <div class="nav-spinner" id="sp${i}"></div>
                        <span id="navtxt${i}">ğŸ§­ ç«‹å³å¯¼èˆª</span>
                    </button>
                </div>`;
            box.appendChild(d);
        });
        sec.classList.add('show');
        sec.scrollIntoView({behavior:'smooth',block:'start'});
    }

    // -------- å¯¼èˆªæ ¸å¿ƒé€»è¾‘ --------
    async function navTo(i){
        const item = addrs[i];
        const btn  = document.getElementById('nav'+i);
        const sp   = document.getElementById('sp'+i);
        const tx   = document.getElementById('navtxt'+i);

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        btn.classList.add('loading');
        sp.style.display='block';
        tx.textContent='å®šä½ä¸­...';

        try {
            // ç¬¬ä¸€æ­¥ï¼šç”¨é«˜å¾·åœ°ç†ç¼–ç APIæŠŠåœ°å€è½¬æˆåæ ‡
            const coords = await geocode(item.address);

            if(coords){
                // æœ‰åæ ‡ï¼šç›´æ¥ç”¨åæ ‡è·³è½¬ï¼Œä½“éªŒæœ€å¥½ï¼ˆç›´æ¥æ˜¾ç¤ºè·¯çº¿è§„åˆ’é¡µï¼‰
                const {lng, lat} = coords;
                const ua = navigator.userAgent.toLowerCase();
                let url;
                if(/iphone|ipad|ipod/.test(ua)){
                    // iOSï¼šç”¨iosamap scheme
                    url = `iosamap://path?sourceApplication=nav&dlat=${lat}&dlon=${lng}&dname=${encodeURIComponent(item.address)}&dev=0&t=0`;
                } else {
                    // å®‰å“ï¼šç”¨androidamap scheme
                    url = `androidamap://route/plan/?sourceApplication=nav&dlat=${lat}&dlon=${lng}&dname=${encodeURIComponent(item.address)}&dev=0&t=0`;
                }
                // å…ˆå°è¯•APP schemeï¼Œå¤±è´¥å°±ç”¨ç½‘é¡µç‰ˆ
                tryOpenApp(url, lng, lat, item.address);
            } else {
                // æ— åæ ‡ï¼šç›´æ¥ç”¨åœ°å€æ–‡å­—è·³è½¬
                fallbackNav(item.address);
            }
        } catch(e) {
            fallbackNav(item.address);
        } finally {
            btn.classList.remove('loading');
            sp.style.display='none';
            tx.textContent='ğŸ§­ ç«‹å³å¯¼èˆª';
        }
    }

    // åœ°å€è½¬åæ ‡ï¼ˆé«˜å¾·åœ°ç†ç¼–ç ï¼‰
    async function geocode(address){
        try {
            // ä½¿ç”¨é«˜å¾· Web API åœ°ç†ç¼–ç 
            const url = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(address)}&key=${AMAP_KEY}&output=json`;
            const res = await fetch(url);
            const data = await res.json();
            if(data.status==='1' && data.geocodes && data.geocodes.length>0){
                const loc = data.geocodes[0].location; // "ç»åº¦,çº¬åº¦"
                const [lng, lat] = loc.split(',').map(Number);
                return {lng, lat};
            }
        } catch(e){}
        return null;
    }

    // å°è¯•å”¤èµ·APPï¼Œå¤±è´¥åˆ™ç”¨ç½‘é¡µ
    function tryOpenApp(appUrl, lng, lat, address){
        // è®°å½•æ—¶é—´ï¼Œå¦‚æœ1.5ç§’åè¿˜åœ¨é¡µé¢è¯´æ˜APPæ²¡å®‰è£…
        const start = Date.now();
        window.location.href = appUrl;
        setTimeout(()=>{
            // å¦‚æœé¡µé¢è¿˜åœ¨ï¼ˆAPPæœªå®‰è£…æˆ–å”¤èµ·å¤±è´¥ï¼‰
            if(Date.now() - start < 2500){
                fallbackNav(address, lng, lat);
            }
        }, 1500);
    }

    // é™çº§æ–¹æ¡ˆï¼šç”¨é«˜å¾·ç½‘é¡µç‰ˆï¼ˆå¸¦åæ ‡ï¼‰
    function fallbackNav(address, lng, lat){
        let url;
        if(lng && lat){
            url = `https://uri.amap.com/navigation?to=${lng},${lat},${encodeURIComponent(address)}&mode=car&policy=1&coordinate=gaode&callnative=1`;
        } else {
            url = `https://uri.amap.com/navigation?to=${encodeURIComponent(address)}&mode=car&policy=1&coordinate=gaode&callnative=1`;
        }
        window.location.href = url;
    }

    // -------- å¤åˆ¶åœ°å€ --------
    function copyAddr(i){
        const a=addrs[i].address;
        const btn=document.getElementById('cp'+i);
        const write=()=>{ btn.textContent='âœ“ å·²å¤åˆ¶'; btn.classList.add('ok'); setTimeout(()=>{btn.textContent='ğŸ“‹ å¤åˆ¶åœ°å€';btn.classList.remove('ok');},2000); };
        if(navigator.clipboard){ navigator.clipboard.writeText(a).then(write).catch(()=>fallbackCopy(a,write)); }
        else fallbackCopy(a,write);
    }
    function fallbackCopy(text,cb){ const ta=document.createElement('textarea'); ta.value=text; ta.style.cssText='position:fixed;opacity:0'; document.body.appendChild(ta); ta.select(); try{document.execCommand('copy');cb();}catch(e){} document.body.removeChild(ta); }

    function clearAll(){ document.getElementById('txt').value=''; clearResults(); }
    function clearResults(){ document.getElementById('results').classList.remove('show'); document.getElementById('empty').classList.remove('show'); document.getElementById('err').classList.remove('show'); document.getElementById('addrList').innerHTML=''; addrs=[]; }

    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
</script>
</body>
</html>
